name: arXiv AI Feed Pipeline

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Required to commit and push changes
permissions:
  contents: write

jobs:
  update-arxiv-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml requests
      
      - name: Create scripts directory
        run: mkdir -p scripts
      
      - name: Create fetcher script
        run: |
          cat > scripts/fetch_arxiv_papers.py << 'EOF'
          #!/usr/bin/env python3
          """Fetch latest papers from arXiv cs.AI category."""
          
          import sys
          import time
          import xml.etree.ElementTree as ET
          import requests
          import yaml
          from pathlib import Path
          
          API_URL = "http://export.arxiv.org/api/query"
          OUTPUT_FILE = "_data/arxiv_papers.yml"
          
          def fetch_papers(category="cs.AI", max_results=10):
              """Fetch papers from arXiv API."""
              params = {
                  "search_query": f"cat:{category}",
                  "sortBy": "submittedDate",
                  "sortOrder": "descending",
                  "max_results": max_results
              }
              
              print(f"Fetching {max_results} papers from {category}...")
              
              try:
                  response = requests.get(API_URL, params=params, timeout=30)
                  response.raise_for_status()
                  time.sleep(3)  # Respect rate limit
                  return response.content
              except requests.RequestException as e:
                  print(f"Error fetching papers: {e}", file=sys.stderr)
                  return None
          
          def parse_papers(xml_content):
              """Parse arXiv XML response."""
              if not xml_content:
                  return []
              
              try:
                  root = ET.fromstring(xml_content)
                  ns = {'atom': 'http://www.w3.org/2005/Atom'}
                  
                  papers = []
                  for entry in root.findall('atom:entry', ns):
                      # Extract paper ID
                      id_url = entry.find('atom:id', ns).text
                      paper_id = id_url.split('/')[-1].split('v')[0]
                      
                      # Extract title
                      title = entry.find('atom:title', ns).text
                      title = ' '.join(title.split())  # Clean whitespace
                      
                      # Extract authors
                      authors = [
                          a.find('atom:name', ns).text 
                          for a in entry.findall('atom:author', ns)
                      ]
                      authors_str = ', '.join(authors)
                      
                      # Extract abstract
                      abstract = entry.find('atom:summary', ns).text
                      abstract = ' '.join(abstract.split())  # Clean whitespace
                      
                      # Extract published date
                      published = entry.find('atom:published', ns).text[:10]
                      
                      # Construct URLs
                      pdf_url = f"http://arxiv.org/pdf/{paper_id}"
                      arxiv_url = f"http://arxiv.org/abs/{paper_id}"
                      
                      papers.append({
                          'id': paper_id,
                          'title': title,
                          'authors': authors_str,
                          'abstract': abstract,
                          'published': published,
                          'pdf_url': pdf_url,
                          'arxiv_url': arxiv_url,
                          'key_findings': ''
                      })
                  
                  return papers
              except Exception as e:
                  print(f"Error parsing XML: {e}", file=sys.stderr)
                  return []
          
          def save_papers(papers, filepath=OUTPUT_FILE):
              """Save papers to YAML file."""
              Path(filepath).parent.mkdir(parents=True, exist_ok=True)
              
              data = {'papers': papers}
              
              try:
                  with open(filepath, 'w', encoding='utf-8') as f:
                      yaml.dump(data, f, 
                               default_flow_style=False,
                               allow_unicode=True,
                               sort_keys=False)
                  print(f"âœ“ Saved {len(papers)} papers to {filepath}")
                  return True
              except Exception as e:
                  print(f"Error saving YAML: {e}", file=sys.stderr)
                  return False
          
          def main():
              xml_content = fetch_papers()
              papers = parse_papers(xml_content)
              
              if papers:
                  save_papers(papers)
                  print(f"âœ“ Successfully fetched and saved {len(papers)} papers")
                  return 0
              else:
                  print("No papers fetched", file=sys.stderr)
                  # Create empty file to avoid breaking pipeline
                  save_papers([])
                  return 1
          
          if __name__ == "__main__":
              sys.exit(main())
          EOF
          
          chmod +x scripts/fetch_arxiv_papers.py
      
      - name: Fetch papers from arXiv
        run: python scripts/fetch_arxiv_papers.py
      
      - name: Generate key findings
        run: |
          cat > scripts/generate_key_findings.py << 'EOF'
          #!/usr/bin/env python3
          """Generate key findings from paper abstracts."""
          
          import sys
          import yaml
          
          INPUT_FILE = "_data/arxiv_papers.yml"
          
          def extract_key_sentences(abstract, max_sentences=3):
              """Extract first N sentences from abstract as key findings."""
              sentences = abstract.replace('?', '.').replace('!', '.').split('.')
              sentences = [s.strip() for s in sentences if s.strip()]
              
              key_findings = '. '.join(sentences[:max_sentences])
              if key_findings and not key_findings.endswith('.'):
                  key_findings += '.'
              
              return key_findings
          
          def generate_findings():
              """Generate key findings for papers."""
              try:
                  with open(INPUT_FILE, 'r', encoding='utf-8') as f:
                      data = yaml.safe_load(f)
              except FileNotFoundError:
                  print(f"File not found: {INPUT_FILE}", file=sys.stderr)
                  return 1
              except Exception as e:
                  print(f"Error reading YAML: {e}", file=sys.stderr)
                  return 1
              
              if not data or 'papers' not in data:
                  print("No papers in data file", file=sys.stderr)
                  return 1
              
              updated_count = 0
              for paper in data['papers']:
                  if not paper.get('key_findings'):
                      abstract = paper.get('abstract', '')
                      if abstract:
                          paper['key_findings'] = extract_key_sentences(abstract)
                          updated_count += 1
                      else:
                          paper['key_findings'] = 'Abstract not available.'
              
              # Save updated data
              try:
                  with open(INPUT_FILE, 'w', encoding='utf-8') as f:
                      yaml.dump(data, f,
                               default_flow_style=False,
                               allow_unicode=True,
                               sort_keys=False)
                  print(f"âœ“ Generated key findings for {updated_count} papers")
                  return 0
              except Exception as e:
                  print(f"Error writing YAML: {e}", file=sys.stderr)
                  return 1
          
          def main():
              return generate_findings()
          
          if __name__ == "__main__":
              sys.exit(main())
          EOF
          
          chmod +x scripts/generate_key_findings.py
          python scripts/generate_key_findings.py
      
      - name: Create dashboard page
        run: |
          mkdir -p _pages _includes
          
          # Create dashboard page
          cat > _pages/arxiv-feed.md << 'EOF'
          ---
          layout: archive
          title: "Latest AI Research from arXiv"
          permalink: /arxiv-feed/
          author_profile: true
          ---
          
          <div class="arxiv-feed">
            <p class="feed-intro">
              Displaying the 10 most recent papers from the <strong>cs.AI</strong> (Artificial Intelligence) category, 
              updated hourly via automated pipeline.
            </p>
            
            <p class="feed-updated">
              Last updated: <time datetime="{{ site.time | date_to_xmlschema }}">
                {{ site.time | date: "%B %d, %Y at %I:%M %p UTC" }}
              </time>
            </p>
            
            {% if site.data.arxiv_papers.papers.size > 0 %}
              <div class="papers-container">
                {% for paper in site.data.arxiv_papers.papers %}
                  {% include paper-card.html paper=paper %}
                {% endfor %}
              </div>
            {% else %}
              <div class="no-papers">
                <p>ðŸ“„ No papers available yet. Check back soon!</p>
              </div>
            {% endif %}
          </div>
          
          <style>
          .arxiv-feed {
            max-width: 900px;
            margin: 0 auto;
          }
          
          .feed-intro {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 1em;
          }
          
          .feed-updated {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-bottom: 2em;
            text-align: right;
          }
          
          .papers-container {
            display: grid;
            gap: 2em;
          }
          
          .no-papers {
            text-align: center;
            padding: 4em 2em;
            color: #999;
            font-size: 1.1em;
          }
          </style>
          EOF
          
          # Create paper card component
          cat > _includes/paper-card.html << 'EOF'
          <article class="paper-card">
            <header class="paper-header">
              <h3 class="paper-title">
                <a href="{{ include.paper.arxiv_url }}" target="_blank" rel="noopener noreferrer">
                  {{ include.paper.title }}
                </a>
              </h3>
              
              <div class="paper-meta">
                <span class="paper-id">{{ include.paper.id }}</span>
                <span class="paper-date">{{ include.paper.published | date: "%b %d, %Y" }}</span>
              </div>
            </header>
            
            <div class="paper-authors">
              <strong>Authors:</strong> {{ include.paper.authors }}
            </div>
            
            <div class="paper-content">
              {% if include.paper.key_findings and include.paper.key_findings != "" %}
                <p class="paper-findings">{{ include.paper.key_findings }}</p>
              {% else %}
                <p class="paper-abstract">{{ include.paper.abstract | truncate: 200 }}</p>
              {% endif %}
            </div>
            
            <footer class="paper-actions">
              <a href="{{ include.paper.arxiv_url }}" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                View on arXiv
              </a>
              <a href="{{ include.paper.pdf_url }}" class="btn btn-secondary" target="_blank" rel="noopener noreferrer">
                Download PDF
              </a>
            </footer>
          </article>
          
          <style>
          .paper-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5em;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
          }
          
          .paper-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
          }
          
          .paper-header {
            margin-bottom: 1em;
          }
          
          .paper-title {
            margin: 0 0 0.5em 0;
            font-size: 1.3em;
            line-height: 1.3;
          }
          
          .paper-title a {
            color: #2c3e50;
            text-decoration: none;
          }
          
          .paper-title a:hover {
            color: #0066cc;
            text-decoration: underline;
          }
          
          .paper-meta {
            display: flex;
            gap: 1em;
            font-size: 0.85em;
            color: #666;
          }
          
          .paper-id {
            font-family: monospace;
            background: #f5f5f5;
            padding: 0.2em 0.5em;
            border-radius: 3px;
          }
          
          .paper-authors {
            margin-bottom: 1em;
            font-size: 0.9em;
            color: #555;
          }
          
          .paper-content {
            margin-bottom: 1.5em;
            line-height: 1.6;
          }
          
          .paper-findings {
            font-style: italic;
            background: #f9f9f9;
            padding: 1em;
            border-left: 3px solid #0066cc;
            border-radius: 0 4px 4px 0;
          }
          
          .paper-abstract {
            color: #666;
          }
          
          .paper-actions {
            display: flex;
            gap: 0.75em;
          }
          
          .btn {
            padding: 0.6em 1.2em;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-block;
          }
          
          .btn-primary {
            background: #0066cc;
            color: white;
          }
          
          .btn-primary:hover {
            background: #0052a3;
          }
          
          .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
          }
          
          .btn-secondary:hover {
            background: #e0e0e0;
          }
          
          @media (max-width: 768px) {
            .paper-card {
              padding: 1em;
            }
            
            .paper-title {
              font-size: 1.1em;
            }
            
            .paper-actions {
              flex-direction: column;
            }
            
            .btn {
              text-align: center;
              width: 100%;
            }
          }
          </style>
          EOF
          
          echo "âœ“ Created dashboard components"
      
      - name: Update navigation
        run: |
          # Check if navigation file exists and add arXiv feed link if not present
          if [ -f "_data/navigation.yml" ]; then
            if ! grep -q "arXiv Feed" _data/navigation.yml; then
              # Add arXiv Feed to navigation before CV (or at end if CV not found)
              if grep -q "CV" _data/navigation.yml; then
                sed -i '/- title: "CV"/i\  - title: "arXiv Feed"\n    url: /arxiv-feed/' _data/navigation.yml
              else
                echo '  - title: "arXiv Feed"' >> _data/navigation.yml
                echo '    url: /arxiv-feed/' >> _data/navigation.yml
              fi
              echo "âœ“ Added arXiv Feed to navigation"
            else
              echo "âœ“ arXiv Feed already in navigation"
            fi
          fi
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add _data/arxiv_papers.yml _pages/arxiv-feed.md _includes/paper-card.html _data/navigation.yml scripts/
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update arXiv feed: $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push origin main
            echo "âœ“ Changes pushed successfully"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## arXiv Feed Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "_data/arxiv_papers.yml" ]; then
            paper_count=$(grep -c "^  - id:" _data/arxiv_papers.yml || echo "0")
            echo "âœ… Fetched $paper_count papers" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to fetch papers" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dashboard: https://etlee110.github.io/test-pages/arxiv-feed/" >> $GITHUB_STEP_SUMMARY
